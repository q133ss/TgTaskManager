<?php

namespace App\Http\Controllers;

use App\Models\User;
use App\Services\TaskService;
use App\Services\TelegramService;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class TelegramBotController extends Controller
{
    protected TelegramService $telegramService;
    protected TaskService $taskService;

    public function __construct(TelegramService $telegramService, TaskService $taskService)
    {
        $this->telegramService = $telegramService;
        $this->taskService = $taskService;
    }

    private function getTaskKeyboard(string $chatId): array
    {
        return [
            'inline_keyboard' => [
                [
                    [
                        'text' => "inbox",
                        'web_app' => [
                            'url' => route('telegram.inbox', ['chat_id' => $chatId])
                        ]
                    ]
                ]
            ]
        ];
    }

    private function sendTasksMessage($taks, $chatId, $isGroup = false){
        if($taks->isEmpty()){
            $this->telegramService->sendMessage($chatId, '–ó–∞–¥–∞—á–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
            return;
        }
        $taskText = '';
        foreach ($taks as $task) {
            $taskText .= '‚Ä¢ '.$task->text . PHP_EOL;
        }

        if(!$isGroup){
            $keyboard = $this->getTaskKeyboard($chatId);
            $this->telegramService->sendMessage($chatId, $taskText, json_encode($keyboard));
        }else{
            $this->telegramService->sendMessage($chatId, $taskText);
        }
    }

    /**
     * @param $chatId
     * @param $text
     * @param $user
     * @param $isGroup
     * @return bool
     *
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã. –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false
     */
    private function proccesedCommand($chatId, $text, $user, $isGroup): bool
    {
        switch ($text) {
            case '/start':
                $this->sendWelcomeMessage($chatId);
                break;
            case '/all':
                $taks = $user->tasks;
                $this->sendTasksMessage($taks, $chatId, $isGroup);
                break;
            case '/today':
                $taks = $user->tasks?->where('date', now()->format('Y-m-d'));
                $this->sendTasksMessage($taks, $chatId, $isGroup);
                break;
            case '/tomorrow':
                $taks = $user->tasks?->where('date', now()->addDay()->format('Y-m-d'));
                $this->sendTasksMessage($taks, $chatId, $isGroup);
                break;
            case '/help':
                $this->telegramService?->sendMessage($chatId, '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é ¬´OK, Bob!¬ª –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ okbob.app.

–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã –≤ OK, Bob!

–ó–∞–¥–∞—á–∏
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á
‚Ä¢ –°–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á
‚Ä¢ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–¥–∞—á–∏
‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
‚Ä¢ –¢–µ–≥–∏
‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–∞–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö
‚Ä¢ –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –≥—Ä—É–ø–ø–∞—Ö
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏
‚Ä¢ –û—Ç—á–µ—Ç—ã

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚Ä¢ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –≤ Telegram
‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: iCalendar
‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –≤–µ–±—Ö—É–∫–∏
‚Ä¢ –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
‚Ä¢ –ò–∫–æ–Ω–∫–∞ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

üì¢ –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª @okbob, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

üë• –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É –≤ —á–∞—Ç–µ @okbob_chat ‚Äì —Ç–∞–º –≤—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.');
                break;
            default:
                // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≥—Ä—É–ø–ø–∞
                if(!isset($message['voice']) && !$isGroup) {
                    $create = $this->taskService?->create($chatId, $text, null);
                    $keyboard = $this->getTaskKeyboard($chatId);
                    $this->telegramService?->sendMessage($chatId, '‚òëÔ∏è' . $create->text, json_encode($keyboard));
                }
                return false;
        }

        return true;
    }

    public function handleUpdate($update): void
    {
        if (isset($update['message'])) {
            $message = $update['message'] ?? '';
            $chatId = $message['chat']['id'] ?? ''; // –ü–æ–ª—É—á–∞–µ–º chat_id
            $text = $message['text'] ?? '';

            $userId = $message['from']['id'];
            $username = $message['from']['username'] ?? 'User';

            $chatType = $message['chat']['type'] ?? '';
            $isGroup = in_array($chatType, ['group', 'supergroup']); // –§–ª–∞–≥. –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã –∏–ª–∏ –∏–∑ –ª–∏—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $user = $this->findOrCreateUser($chatId, $message);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (isset($message['voice'])) {
                $this->handleVoiceMessage($message, $chatId, $user);
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –±–æ—Ç–∞
            if (str_starts_with($text, env('BOT_USERNAME'))) {
                $this->processTaskGroupCommand($text, $chatId, $userId, $username);
            }

            $this->proccesedCommand($chatId, $text, $user, $isGroup);
        } elseif (isset($update['callback_query'])) {
            $callbackQuery = $update['callback_query'];
            $data = $callbackQuery['data'];
            $chatId = $callbackQuery['message']['chat']['id'];
            $messageId = $callbackQuery['message']['message_id'];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $user = $this->findOrCreateUser($chatId, $callbackQuery['message']['chat']);

            $this->handleCallbackQuery($chatId, $messageId, $data);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç
        if (isset($message['new_chat_members'])) {
            $chatId = $update['message']['chat']['id'];
            foreach ($message['new_chat_members'] as $member) {
                if ($member['id'] == env('BOT_ID')) {
                    $this->telegramService?->sendMessage($chatId, "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ –º–µ–Ω—è –≤ —ç—Ç–æ—Ç —á–∞—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏.");
                }
            }
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤
    private function processTaskGroupCommand($text, $chatId, $userId, $username)
    {
        // –£–¥–∞–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        $taskText = str_replace(env('BOT_USERNAME'), '', $text);

        // –†–∞–∑–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á—É –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
        preg_match('/@(\w+)$/', $taskText, $assigneeMatch); // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        if (!empty($assigneeMatch)) {
            // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —É–∫–∞–∑–∞–Ω
            $assigneeUsername = $assigneeMatch[1];
            $taskText = trim(str_replace($assigneeMatch[0], '', $taskText)); // –£–¥–∞–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è

            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username
            $assignee = User::where('username', $assigneeUsername)->first();
            if (!$assignee) {
                $this->telegramService?->sendMessage($chatId, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @$assigneeUsername –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /start.");
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $this->taskService?->create($assignee->telegram_id, $taskText, null, $assignee->id);
            $this->telegramService?->sendMessage($chatId, "–ó–∞–¥–∞—á–∞ \"$taskText\" –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é @$assigneeUsername.");
        } else {
            $user = User::where('username', $username)->first();
            if (!$user) {
                $this->telegramService?->sendMessage($chatId, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @$user –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /start.");
                return;
            }
            $formattedText = str_replace(env('BOT_USERNAME'), '', $text);
            $command = $this->proccesedCommand($user->telegram_id, trim($formattedText), $user, true);
            if(!$command){
                $this->taskService?->create($user->telegram_id, $taskText, null, null, $username);
                $this->telegramService?->sendMessage($chatId, "–ó–∞–¥–∞—á–∞ \"$taskText\" —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –≤–∞—Å, @$username.");
            }
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
     */
    private function handleVoiceMessage($message, $chatId, $user)
    {
        $voiceFileId = $message['voice']['file_id'];
        $token = env('BOT_TOKEN');

        try {
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            $fileResponse = Http::get("https://api.telegram.org/bot{$token}/getFile", [
                'file_id' => $voiceFileId,
            ]);
            $fileInfo = json_decode($fileResponse->body(), true);
            $filePath = $fileInfo['result']['file_path'];

            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            $fileUrl = "https://api.telegram.org/file/bot{$token}/{$filePath}";
            $voiceFile = Http::get($fileUrl);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
            $tempFilePath = storage_path('app/temp/' . uniqid() . '.ogg');
            file_put_contents($tempFilePath, $voiceFile->body());

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ Yandex SpeechKit –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            $recognizedText = $this->recognizeSpeechWithYandex($tempFilePath);

            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            unlink($tempFilePath);

            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, —Å–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
            if (!empty($recognizedText)) {
                $create = $this->taskService?->create($chatId, $recognizedText, null);
                $keyboard = $this->getTaskKeyboard($chatId);
                $this->telegramService?->sendMessage($chatId, '‚òëÔ∏è' . $create->text, json_encode($keyboard));
            } else {
                $this->telegramService->sendMessage($chatId, "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.");
            }
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ' . $e->getMessage());
            $this->telegramService->sendMessage($chatId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.");
        }
    }

    /**
     * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç OGG –≤ WAV.
     */
    private function convertOggToWav($oggFilePath): string
    {
        $wavFilePath = str_replace('.ogg', '.wav', $oggFilePath);
        exec("ffmpeg -i {$oggFilePath} -ar 16000 -ac 1 {$wavFilePath}");
        return $wavFilePath;
    }

    /**
     * –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å —Å –ø–æ–º–æ—â—å—é Yandex SpeechKit.
     */
    private function recognizeSpeechWithYandex($oggFilePath): string
    {
        $folderId = env('YANDEX_FOLDER_ID');
        $iamToken = env('YANDEX_IAM_TOKEN');

        if (!$folderId || !$iamToken) {
            Log::error('–ù–µ —É–∫–∞–∑–∞–Ω—ã folderId –∏–ª–∏ iamToken –¥–ª—è Yandex SpeechKit.');
            return '';
        }

        // URL –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        $url = "https://stt.api.cloud.yandex.net/speech/v1/stt:recognize?folderId={$folderId}&lang=ru-RU";

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ cURL
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, file_get_contents($oggFilePath)); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Authorization: Bearer ' . $iamToken,
            'Content-Type: audio/ogg', // –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        ]);

        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode !== 200) {
            Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —Ä–µ—á–∏ (HTTP {$httpCode}): " . $response);
            return '';
        }

        // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        $result = json_decode($response, true);
        return $result['result'] ?? ''; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    }

    /**
     * –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ.
     *
     * @param int $chatId
     * @param array $chatData
     * @return \App\Models\User
     */
    private function findOrCreateUser(int $chatId, array $chatData): \App\Models\User
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º telegram_id
        $user = \App\Models\User::where(['telegram_id' => $chatId])
        ->orWhere('username', $chatData['from']['username'] ?? null)->first();

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π, –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        if (!$user) {
            $user = new \App\Models\User();
            $user->telegram_id = $chatId;
            $user->first_name = $chatData['from']['first_name'] ?? null;
            $user->last_name = $chatData['from']['last_name'] ?? null;
            $user->username = $chatData['from']['username'] ?? null;
            $user->save();

            $this->getAndSaveUserProfilePhotoLink($chatId, $user);
        }

        return $user;
    }

    private function getAndSaveUserProfilePhotoLink(int $chatId, \App\Models\User $user): void
    {
        try {
            $token = env('BOT_TOKEN');
            // –ü–æ–ª—É—á–∞–µ–º file_id –∞–≤–∞—Ç–∞—Ä–∞
            $response = Http::get("https://api.telegram.org/bot{$token}/getUserProfilePhotos", [
                'user_id' => $chatId,
                'limit' => 1,
            ]);
            $userProfilePhotos = json_decode($response->body(), true);

            if (!isset($userProfilePhotos['result']['photos'][0][0])) {
                return; // –ê–≤–∞—Ç–∞—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            }

            $photoFileId = $userProfilePhotos['result']['photos'][0][0]['file_id'];

            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
            $fileResponse = Http::get("https://api.telegram.org/bot{$token}/getFile", [
                'file_id' => $photoFileId,
            ]);
            $fileInfo = json_decode($fileResponse->body(), true);
            $filePath = $fileInfo['result']['file_path'];

            // –°–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∞–≤–∞—Ç–∞—Ä
            $avatarUrl = "https://api.telegram.org/file/bot{$token}/{$filePath}";

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –≤ –º–æ–¥–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $user->avatar_url = $avatarUrl;
        } catch (\Exception $e) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–µ—Ç)
        }
    }

    protected function sendWelcomeMessage($chatId)
    {
        $keyboard = [
            'inline_keyboard' => [
                [
                    ['text' => '–î–∞–ª–µ–µ', 'callback_data' => 'next_2']
                ]
            ]
        ];

        $text = "ü§ñ –ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ ¬´OK, Bob!¬ª ‚Äî –≤–∞—à –±–æ—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ —Ç—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á –¥–ª—è Telegram!

¬´OK, Bob!¬ª –ø–æ–º–æ–∂–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö –ø—Ä—è–º–æ –∏–∑ —á–∞—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏—á–Ω—ã–º–∏ –¥–µ–ª–∞–º–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º. ‚è∞

–í —Å–ª–µ–¥—É—é—â–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –º—ã –∫—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂–µ–º –æ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

üìö –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã /help –≤ –±–æ—Ç–µ.

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∏ –º—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–∂–µ–º! üí¨

–ù–∞–∂–º–∏—Ç–µ –î–∞–ª–µ–µ ‚û°Ô∏è, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –±–æ—Ç–µ.";
        $this->telegramService->sendMessage($chatId, $text, json_encode($keyboard));
    }

    protected function handleCallbackQuery($chatId, $messageId, $data)
    {
        $stepMessages = [
            'next_1' => [
                'text' => 'ü§ñ –ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ ¬´OK, Bob!¬ª ‚Äî –≤–∞—à –±–æ—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ —Ç—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á –¥–ª—è Telegram!

¬´OK, Bob!¬ª –ø–æ–º–æ–∂–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö –ø—Ä—è–º–æ –∏–∑ —á–∞—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏—á–Ω—ã–º–∏ –¥–µ–ª–∞–º–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º. ‚è∞

–í —Å–ª–µ–¥—É—é—â–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –º—ã –∫—Ä–∞—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂–µ–º –æ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

üìö –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã /help –≤ –±–æ—Ç–µ.

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∏ –º—ã —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–∂–µ–º! üí¨

–ù–∞–∂–º–∏—Ç–µ –î–∞–ª–µ–µ ‚û°Ô∏è, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –±–æ—Ç–µ.',
                'next' => 'next_2'
            ],
            'next_2' => [
                'text' => "–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –±–æ—Ç–µ üìù

–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ —Å –±–æ—Ç–æ–º.

–ó–∞–¥–∞—á–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—ã –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ ¬´–ò–Ω–±–æ–∫—Å¬ª ‚Äì —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, –µ—Å–ª–∏:
- –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥ –æ—Ç–≤–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤ –±–æ—Ç–µ;
- –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /inbox –≤ –±–æ—Ç–µ.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á

–ù–∞–∂–º–∏—Ç–µ –î–∞–ª–µ–µ ‚û°Ô∏è, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏ –¥–µ–Ω—å.",
                'next' => 'next_3',
                'back' => 'next_1'
            ],
            'next_3' => [
                'text' => "–ö–∞–∫ —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚è±Ô∏è

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —É–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –±–æ—Ç –¥–æ–±–∞–≤–∏–ª –µ—ë –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å. –í—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É (21.04) –∏–ª–∏ –∫–æ—Å—É—é —á–µ—Ä—Ç—É (21/04);
‚Ä¢ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ —Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞, today, tomorrow –∏–ª–∏ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, —Å—É–±–±–æ—Ç–∞, Wednesday) –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –¥–Ω—è;
‚Ä¢ –∑–∞–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å (14-00) –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–∏–µ (14:00).

–ù–∞–ø—Ä–∏–º–µ—Ä:
–≤—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∑–∞–≤—Ç—Ä–∞ 14:00

–°–æ–∑–¥–∞—Å—Ç –∑–∞–¥–∞—á—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å –Ω–∞ 14 —á–∞—Å–æ–≤.

üìÜ –ï—Å–ª–∏ –≤—ã —É–∫–∞–∑–∞–ª–∏ —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è, –±–µ–∑ –¥–∞—Ç—ã, –∑–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å.
–í –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö –±–æ—Ç —Ç–∞–∫–∂–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —ç—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—ã –∏–∑ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ª–∏—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.",
                'next' => 'next_4',
                'back' => 'next_2'
            ],
            'next_4' => [
                'text' => "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è

–ß—Ç–æ–±—ã –≤—Ä–µ–º—è —É –∑–∞–¥–∞—á –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤–∞–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω GMT+3 (–ú–æ—Å–∫–≤–∞).

‚úàÔ∏è –ß—Ç–æ–±—ã –ø–æ–º–µ–Ω—è—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, –æ—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏–ª–∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

–í —ç—Ç–æ–º –∂–µ —Ä–∞–∑–¥–µ–ª–µ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, –≤—ã–±—Ä–∞—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ–±—ã ¬´OK, Bob!¬ª —Ä–∞–±–æ—Ç–∞–ª —Ç–∞–∫, –∫–∞–∫ —É–¥–æ–±–Ω–æ –∏–º–µ–Ω–Ω–æ –≤–∞–º.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è.",
                'next' => 'next_5',
                'back' => 'next_3'
            ],
            'next_5' => [
                'text' => "–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è ‚è≥

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ–±—ã –±–æ—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–ª –≤–∞—Å. –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 15 –º–∏–Ω—É—Ç, 1 —á–∞—Å –∏–ª–∏ –¥–∞–∂–µ –∑–∞ —Å—É—Ç–∫–∏ –¥–æ –Ω–∞—á–∞–ª–∞.

üîî –î–ª—è —ç—Ç–æ–≥–æ –≤ —Ç–µ–∫—Å—Ç–µ –∑–∞–¥–∞—á–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∑–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏—Å–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –ø–æ—Å–ª–µ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–∫–∞: ![N]–º, –≥–¥–µ N ‚Äì –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ –≤–∞—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å.

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —á–∞—Å–∞—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä:
–í—Å—Ç—Ä–µ—á–∞ –∑–∞–≤—Ç—Ä–∞ 12-00 !1—á
—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –∑–∞–≤—Ç—Ä–∞ –≤ 11.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

‚åõÔ∏è –ï—Å–ª–∏ —É –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (–≤—Å—Ç—Ä–µ—á–∞, –∑–≤–æ–Ω–æ–∫), —É–∫–∞–∂–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∞—Å–∞—Ö (1—á) –∏–ª–∏ –º–∏–Ω—É—Ç–∞—Ö (15–º)‚Äî —Ç–∞–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ì—Ä–∞—Ñ–∏–∫¬ª –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±—É–¥–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –≠—Ç–æ —É–¥–æ–±–Ω–æ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–Ω—è –∏ –∏–∑–±–µ–∂–∞–Ω–∏—è –Ω–∞–∫–ª–∞–¥–æ–∫.

–î–∞–ª–µ–µ ‚û°Ô∏è  ‚Äì –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –≤ —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø–∞—Ö.",
                'next' => 'next_6',
                'back' => 'next_4'
            ],
            'next_6' => [
                'text' => "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç –≤ —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø–∞—Ö üë•

–ß—Ç–æ–±—ã –≤–µ—Å—Ç–∏ –∑–∞–¥–∞—á–∏ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥–æ–π, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –±–æ—Ç–∞ @okbob_bot –≤ –æ–±—â–∏–π —á–∞—Ç. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø–æ–º–∏–Ω–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @username –∏ —Å—Ä–∞–∑—É –Ω–∞–∑–Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.

‚úîÔ∏è –ö–∞–∂–¥—ã–π —Å–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Å–≤–æ–π –ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ß–∞—Ç—ã¬ª –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –∑–∞–¥–∞—á–∏ –≤—Å–µ—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –∏–∑ –≥—Ä—É–ø–ø—ã.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –†–∞–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ –Ø–Ω–¥–µ–∫—Å, Google –∏ Apple.",
                'next' => 'next_7',
                'back' => 'next_5'
            ],
            'next_7' => [
                'text' => "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏: iCalendar –∏ webhooks üîó

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ —Ç–∞—Ä–∏—Ñ–µ ¬´–ë–∏–∑–Ω–µ—Å¬ª –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞.

üìÖ ¬´OK, Bob!¬ª –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç iCalendar, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ —Å–æ–±—ã—Ç–∏—è –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞–ª–µ–Ω–¥–∞—Ä—å, Google Calendar, Apple Calendar –∏ –¥—Ä—É–≥–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ iCalendar

üîÑ –¢–∞–∫–∂–µ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –≤–µ–±—Ö—É–∫–æ–≤ (webhooks) ‚Äî –±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö –≤ –Ω—É–∂–Ω—ã–π –≤–∞–º —Å–µ—Ä–≤–µ—Å.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫–∏

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞.",
                'next' => 'next_8',
                'back' => 'next_6'
            ],
            'next_8' => [
                'text' => '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ üíª

–ó–∞–π–¥–∏—Ç–µ –Ω–∞ hey.okbob.app, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram, –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏, –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π —Å –±–æ–ª—å—à–æ–≥–æ —ç–∫—Ä–∞–Ω–∞.

üñ•Ô∏è –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ –ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á –∏ —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–∞–∫ —á—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å –¥–µ–ª–∞ —Å—Ç–∞–Ω–µ—Ç –µ—â—ë –ø—Ä–æ—â–µ.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –í–µ—Ä—Å–∏—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–≥–∏.',
                'next' => 'next_9',
                'back' => 'next_7',
            ],
            'next_9' => [
                'text' => '–¢–µ–≥–∏ —É –∑–∞–¥–∞—á üè∑Ô∏è

–î–ª—è —É–¥–æ–±–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–∏—Å–∫–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–µ–≥–∏ –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∑–∞–¥–∞—á–∏.

–ù–∞–ø—Ä–∏–º–µ—Ä, #–≤—Å—Ç—Ä–µ—á–∞, #—Å—Ä–æ—á–Ω–æ, #‚ùóÔ∏è ‚Äî –ª—é–±—ã–µ —Å–ª–æ–≤–∞ –∏ –¥–∞–∂–µ emoji, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏.

üîé –ü–æ—Ç–æ–º –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≤—Å—ë –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–µ–≥—É –≤ —Å–ø–∏—Å–∫–∞—Ö –∑–∞–¥–∞—á –≤ –±–æ—Ç–µ –∏–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –¢–µ–≥–∏

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –æ—Ç—á—ë—Ç—ã –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø.',
                'next' => 'next_10',
                'back' => 'next_8',
            ],
            'next_10' => [
                'text' => '–û—Ç—á—ë—Ç—ã –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø üìä

–° –ø–æ–º–æ—â—å—é –æ—Ç—á—ë—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø –≤—ã —Å–º–æ–∂–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –Ω–∞–≥—Ä—É–∑–∫—É –∫–æ–º–∞–Ω–¥—ã: –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –∏ –∫—Ç–æ –∏–∑ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–∫–æ–ª—å–∫–æ —Å–¥–µ–ª–∞–ª.

–û—Ç—á–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –Ω–∞ hey.okbob.app.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –û—Ç—á—ë—Ç—ã –≤ —Ä–∞–±–æ—á–∏—Ö –≥—Ä—É–ø–ø–∞—Ö

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –∫–æ–º–∞–Ω–¥—ã Telegram-–±–æ—Ç–∞.',
                'next' => 'next_11',
                'back' => 'next_9',
            ],
            'next_11' => [
                'text' => '–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –≤ Telegram üí¨
–í —á–∞—Ç–µ —Å –±–æ—Ç–æ–º @okbob_bot –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã, –≤—ã–∑—ã–≤–∞–µ–º—ã–µ —á–µ—Ä–µ–∑ /:
‚Ä¢ /all ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏,
‚Ä¢ /today ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è,
‚Ä¢ /tomorrow ‚Äî –∑–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞,
‚Ä¢ /inbox ‚Äî –∑–∞–¥–∞—á–∏ –±–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–∏–∑ ¬´–ò–Ω–±–æ–∫—Å–∞¬ª),
‚Ä¢/help ‚Äî –ø–æ–º–æ—â—å.

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–≥–∞–º:
‚Ä¢ /all #bob ‚Äî –≤—ã–≤–µ–¥–µ—Ç –≤—Å–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å —Ç–µ–≥–æ–º #bob,
‚Ä¢ /today #bob #work ‚Äî –ø–æ–∫–∞–∂–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–¥–∞—á–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö —Ç–µ–≥–æ–≤.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

–î–∞–ª–µ–µ ‚û°Ô∏è ‚Äì –∫–∞–Ω–∞–ª —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –∏ —á–∞—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.',
                'next' => 'next_12',
                'back' => 'next_10',
            ],
            'next_12' => [
                'text' => '–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ—à–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —Å ¬´OK, Bob!¬ª ü§ñ

üìö –ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –≤—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

üì¢ –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª @okbob, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–º–∏ —É–∑–Ω–∞–≤–∞—Ç—å –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –∏ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö.

üí¨ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É –≤ —á–∞—Ç–µ @okbob_chat, –≥–¥–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏—è.

–£—Å–ø–µ—à–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π!',
                'back' => 'next_11',
                'next' => null
            ]
        ];

        if (isset($stepMessages[$data])) {
            $step = $stepMessages[$data];
            $keyboard = [
                'inline_keyboard' => [
                    array_filter([
                        $step['back'] ? ['text' => '–ù–∞–∑–∞–¥', 'callback_data' => $step['back']] : null,
                        $step['next'] ? ['text' => '–î–∞–ª–µ–µ', 'callback_data' => $step['next']] : null
                    ])
                ]
            ];

            $this->telegramService->editMessageText($chatId, $messageId, $step['text'], json_encode($keyboard));
        }
    }
}
